# Penetration Testing Runbook

This runbook describes the automated penetration testing framework for Stellar Insights. It covers CI jobs, secrets required, triage steps, and manual run instructions.

## Overview

Automated scans added:
- CodeQL (code analysis)
- Dependabot (dependency updates)
- Trivy (filesystem / container image scanning)
- tfsec (Terraform static checks)
- OWASP ZAP (dynamic scan against staging)

Workflows added:
- `.github/workflows/codeql-analysis.yml` (CodeQL on PRs + nightly)
- `.github/dependabot.yml` (dependency updates)
- `.github/workflows/security-scan.yml` (Trivy + tfsec on PRs + nightly)
- `.github/workflows/zap-scan.yml` (OWASP ZAP against staging nightly)

## Required repository secrets

Add the following repository secrets (Actions → Settings → Secrets):

- `STAGING_URL` — full URL of the staging deployment (https://staging.example.com)
- `MAIL_HOST` — SMTP host (optional, for email alerts)
- `MAIL_PORT` — SMTP port
- `MAIL_USERNAME` — SMTP username
- `MAIL_PASSWORD` — SMTP password
- `MAIL_FROM` — From address for alerts
- `MAIL_TO` — Comma-separated recipient list

> If email is not configured, the workflows will still create GitHub issues for findings.

## How to run locally

### Trivy local scan

```bash
# install trivy
brew install trivy
trivy fs --format json -o trivy-report.json .
jq . trivy-report.json
```

### tfsec local scan

```bash
# install tfsec
brew install tfsec
tfsec --format json -o tfsec-report.json terraform/
```

### ZAP local quick run

```bash
docker run --rm -v $(pwd):/zap/wrk/:Z owasp/zap2docker-stable zap-baseline.py -t "https://staging.example.com" -r zap-report.html -J zap-report.json
```

## Triage process

1. When a GitHub issue is created by the workflow, add the appropriate label: `security/critical`, `security/high`, `security/medium`, `security/low`.
2. Assign to the on-call owner or the `security` team.
3. Reproduce findings locally using the commands above.
4. For code-level issues, create a PR with a fix and reference the issue number.
5. For dependency or infra issues, follow the remediation guidance (upgrade, patch, or change configuration).
6. After remediation, close the GitHub issue and include verification steps.

## False positives

- If a finding is a false positive, document why in the issue and close it with the `security/false-positive` label.
- Keep a short record in the issue for future reference.

## Escalation

- Critical findings: page on-call and open an incident channel (Slack/email).
- High findings: triage within 24 hours.

## Maintenance

- Review and update `PENTEST_RUNBOOK.md` quarterly.
- Update dependencies scanned by Dependabot weekly.
- Review CodeQL alerts and suppress only with a documented rationale.

## Contacts

- Security owner: @Ndifreke000
- Infrastructure owner: @Joewizy
